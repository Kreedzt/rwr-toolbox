# Data Model: Full Carry Items Parsing with Extended Attributes

**Feature**: 006-carry-items-full-parsing
**Status**: Implemented (40/47 tasks complete, 7 manual testing remaining)

## Entity Relationships

```
┌─────────────────────────────────────────────────────────────┐
│                         Game Directory                         │
│                        (packages/)                             │
└──────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                      .carry_item XML File                      │
│                     (e.g., vest2.carry_item)                  │
│                                                               │
│  <carry_items>                                                 │
│    ├── <carry_item key="..." name="..." slot="..."             │
│    │         ├── <capacity value="1" source="rank"/>          │
│    │         ├── <inventory encumbrance="30" price="20"/>     │
│    │         ├── <commonness value="0.05" in_stock="1"/>      │
│    │         ├── <modifier class="..." value="-2.5"/>        │
│    │         └── ...                                             │
│    └── <carry_item key="..." name="..." ...>                   │
│         └── ... (15 items total in vest2.carry_item)          │
└──────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                      Rust Backend Parsing                     │
│                      (src-tauri/src/items.rs)                   │
│                                                               │
│  RawCarryItemsRoot.items (Vec<RawCarryItem>)               │
│       │                                                       │
│       ▼                                                       │
│  parse_carry_item() → Vec<Item>                               │
│       │                                                       │
│       ├── ItemCapacity (value, source, source_value)         │
│       ├── ItemCommonness (value, in_stock, can_respawn_with) │
│       ├── ItemModifier[] (modifier_class, value, states...)   │
│       ├── transform_on_consume: Option<String>               │
│       ├── time_to_live_out_in_the_open: Option<f64>          │
│       └── draggable: Option<bool>                             │
└──────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                     Frontend Data Models                        │
│                  (src/app/shared/models/items.models.ts)        │
│                                                               │
│  GenericItem (union type: CarryItem | VisualItem)            │
│       │                                                       │
│       ├── _id: string (generated frontend)                   │
│       ├── key?: string                                       │
│       ├── name: string                                       │
│       ├── itemType: 'carry_item' | 'visual_item'              │
│       ├── encumbrance?: number                               │
│       ├── price?: number                                     │
│       ├── canRespawnWith?: boolean                          │
│       ├── inStock?: boolean                                   │
│       ├── filePath: string                                   │
│       ├── sourceFile: string                                 │
│       ├── packageName: string                                │
│       ├── sourceDirectory: string                            │
│       ├── capacity?: ItemCapacity                           │
│       ├── commonness?: ItemCommonness                       │
│       ├── modifiers?: ItemModifier[]                         │
│       ├── transformOnConsume?: string   ← NEW                │
│       ├── timeToLiveOutInTheOpen?: number ← NEW              │
│       └── draggable?: boolean          ← NEW                │
│                                                               │
│  ItemCapacity { value?, source?, sourceValue? }              │
│  ItemCommonness { value?, inStock?, canRespawnWith? }        │
│  ItemModifier { _id?, modifierClass, value?,                  │
│                  inputCharacterState?, outputCharacterState?,   │
│                  consumesItem? }                                │
└─────────────────────────────────────────────────────────────┘
```

## Entity Definitions

### GenericItem

The base interface for all item types in the RWR game data.

**Type**: Union type (CarryItem | VisualItem)

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | `string` | No | Unique identifier generated by frontend for Angular tracking (not persisted) |
| `key` | `string` | No | Item identifier (filename without extension, or generated for multi-item files) |
| `name` | `string` | Yes | Display name shown to users |
| `itemType` | `string` | Yes | Either "carry_item" or "visual_item" |
| `encumbrance` | `number` | No | Weight/encumbrance value |
| `price` | `number` | No | In-game cost |
| `canRespawnWith` | `boolean` | No | Whether item can be respawned with |
| `inStock` | `boolean` | No | Whether item is in stock |
| `filePath` | `string` | Yes | Relative file path from packages directory (e.g., "vanilla/items/vest2.carry_item") |
| `sourceFile` | `string` | Yes | Original absolute XML file path |
| `packageName` | `string` | Yes | Package name (vanilla or mod) |
| `sourceDirectory` | `string` | Yes | Directory path where this item was scanned from |
| `capacity` | `ItemCapacity` | No | Capacity/spawn requirements |
| `commonness` | `ItemCommonness` | No | Spawn frequency settings |
| `modifiers` | `ItemModifier[]` | No | Gameplay effect modifiers |
| `transformOnConsume` | `string` | No | What item/state this transforms to when consumed (e.g., "Health, 130%") |
| `timeToLiveOutInTheOpen` | `number` | No | Survival time in seconds after being dropped (0.0 = disappears immediately) |
| `draggable` | `boolean` | No | Whether the item can be dragged by the player |

### CarryItem

Specialized interface for carryable game items (weapons, health packs, etc.)

**Extends**: GenericItem

**Additional Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `slot` | `string` | No | Inventory slot (0, 1, 2, etc.) |
| `transformOnConsume` | `string` | No | Target item/key on consumption |
| `timeToLiveOutInTheOpen` | `number` | No | Despawn time when dropped (seconds) |
| `draggable` | `boolean` | No | Whether draggable in UI |
| `hudIcon` | `string` | No | HUD icon filename |
| `modelFilename` | `string` | No | 3D model filename |

### VisualItem

Specialized interface for visual-only items (cosmetics, effects)

**Extends**: GenericItem

**Additional Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `meshFilenames` | `string[]` | No | List of mesh filenames |
| `effectRef` | `string` | No | Effect reference identifier |

### ItemCapacity

Represents spawning rank requirements for carry items.

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `value` | `number` | No | Capacity value (e.g., 1 = rank 1 required) |
| `source` | `string` | No | Source type (e.g., "rank") |
| `sourceValue` | `number` | No | Source value |

### ItemCommonness

Represents spawn frequency and availability settings.

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `value` | `number` | No | Spawn probability (0.0 - 1.0) |
| `inStock` | `boolean` | No | Whether item is in stock |
| `canRespawnWith` | `boolean` | No | Whether item can be respawned with |

### ItemModifier

Represents a gameplay effect modifier attached to an item.

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | `string` | No | Unique identifier generated by frontend for Angular tracking |
| `modifierClass` | `string` | Yes | Modifier class type (e.g., "hit_success_probability", "projectile_blast_result") |
| `value` | `number` | No | Numeric modifier value (e.g., -2.5 for hit penalty) |
| `inputCharacterState` | `string` | No | Input character state (e.g., "death", "wound", "stun") |
| `outputCharacterState` | `string` | No | Output character state after modifier applies |
| `consumesItem` | `boolean` | No | Whether item is consumed when modifier triggers |

## State Transitions

### Item Transformation Flow

```
Current Item (e.g., "Health, 150%")
    │
    │ (consumed by damage or pickup)
    ▼
transform_on_consume → Target Item (e.g., "Health, 140%")
    │
    │ (can continue chain)
    ▼
... (can chain through multiple degradation levels)
```

### Modifier State Transition Flow

```
Input Character State
    │
    ├─→ [Modifier with input/output states]
    │
    ▼
Output Character State
    │
    │ (consumes_item = true?)
    ▼
Item consumed/removed from inventory
```

## Data Validation Rules

1. **Multi-Item File Parsing**: All `<carry_item>` elements must be parsed; duplicate keys within same file must be flagged
2. **Capacity Defaults**: When missing, display as "-" in table
3. **Commonness Defaults**: When missing, display as "-" in table; boolean badges shown as badge-ghost for false
4. **Modifier Defaults**: Empty modifierClass shows as "(no class)"; missing value shows as "-"
5. **Transform On Consume**: Empty string shows as "-" in table
6. **Time To Live**: Missing value shows as "-" in table
7. **Draggable**: Missing defaults to false (not draggable), shown as badge-ghost

## Cardinality

- **One File → Many Items**: A single .carry_item file can contain 1 to 15+ items
- **One Item → Many Modifiers**: An item can have 0 to 10+ modifiers
- **Item → One Capacity**: Each item has at most one capacity definition
- **Item → One Commonness**: Each item has at most one commonness definition

## Index Rules

- **Items**: Uniquely identified by `_id` (frontend-generated UUID) or composite key (sourceFile + key)
- **Modifiers**: Uniquely identified by `_id` (frontend-generated UUID)
- **Duplicate Keys**: Backend flags duplicate keys within same file in `scan_errors`
